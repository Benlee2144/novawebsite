<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Semantic Search &mdash; Find Related Concepts &mdash; The Unveiled Word</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .search-container { max-width: 800px; margin: 0 auto; padding: 1rem; }
    .big-search {
      width: 100%; padding: 1rem 1.5rem; font-size: 1.2rem; border: 3px solid var(--gold,#c5960c);
      border-radius: 12px; background: var(--parchment,#faf6ef); color: var(--ink,#3c2f2f);
      font-family: var(--font-reading,Georgia,serif); box-sizing: border-box;
    }
    .big-search:focus { outline: none; box-shadow: 0 0 20px rgba(197,150,12,0.3); }
    .topic-suggestions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; justify-content: center; }
    .topic-btn {
      padding: 0.4rem 1rem; border: 1px solid rgba(197,150,12,0.3); border-radius: 20px;
      background: rgba(197,150,12,0.05); color: var(--ink,#3c2f2f); font-size: 0.85rem; cursor: pointer;
    }
    .topic-btn:hover { background: rgba(197,150,12,0.15); border-color: var(--gold,#c5960c); }
    .result-group { margin: 1.5rem 0; }
    .group-label {
      font-family: var(--font-heading,'Cinzel',serif); font-size: 1rem; color: var(--gold,#c5960c);
      border-bottom: 2px solid rgba(197,150,12,0.2); padding-bottom: 0.3rem; margin-bottom: 0.5rem;
    }
    .result-item {
      padding: 0.8rem 1rem; margin: 0.3rem 0; border-radius: 6px;
      border: 1px solid rgba(197,150,12,0.1); background: rgba(197,150,12,0.02);
    }
    .result-item:hover { border-color: var(--gold,#c5960c); }
    .result-item a { color: var(--ultramarine,#1e3a6e); text-decoration: none; font-family: var(--font-heading,'Cinzel',serif); font-size: 0.95rem; }
    .result-item a:hover { text-decoration: underline; }
    .result-cat { font-size: 0.7rem; color: var(--gold,#c5960c); text-transform: uppercase; margin-left: 0.5rem; }
    .result-snippet { font-size: 0.85rem; color: var(--text-faded,#6b5b4a); margin-top: 0.2rem; line-height: 1.4; }
    .result-count { text-align: center; color: var(--text-faded,#6b5b4a); font-size: 0.9rem; margin: 1rem 0; }
    .loading { text-align: center; color: var(--gold,#c5960c); padding: 2rem; font-style: italic; }
  </style>
</head>
<body>
  <main class="search-container">
    <h1 style="text-align:center;font-family:var(--font-heading,'Cinzel',serif);color:var(--leather-dark,#2c1810);">
      üîç Semantic Search
    </h1>
    <p style="text-align:center;font-family:var(--font-reading,Georgia,serif);color:var(--ink,#3c2f2f);max-width:600px;margin:0 auto 1rem;">
      Search across all 35,405 pages ‚Äî studies, lexicon entries, interlinear chapters, reference articles. Results grouped by category with relevance ranking.
    </p>
    <input type="text" class="big-search" id="q" placeholder="Try: grace, love, covenant, atonement, resurrection..." autofocus>
    <div class="topic-suggestions" id="topics"></div>
    <div class="result-count" id="count"></div>
    <div id="results"></div>
    <div class="loading" id="loading" style="display:none;">Loading search index (7MB)...</div>
  </main>

  <script>
  const TOPICS = [
    'grace and mercy', 'resurrection', 'covenant', 'Holy Spirit', 'atonement',
    'faith vs works', 'love', 'sin', 'prophecy fulfilled', 'kingdom of God',
    'prayer', 'angels', 'hell sheol hades', 'baptism', 'creation',
    'David', 'Abraham', 'Paul', 'Mary', 'Moses'
  ];

  const CATEGORY_ORDER = ['study','lexicon','reference','interlinear','parallel','tool'];
  const CATEGORY_LABELS = {study:'Studies',lexicon:'Lexicon',reference:'Reference',interlinear:'Interlinear',parallel:'Parallel',tool:'Tools'};

  let searchIndex = null;
  let debounce = null;

  // Build topic buttons
  const topicsEl = document.getElementById('topics');
  TOPICS.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'topic-btn'; btn.textContent = t;
    btn.onclick = () => { document.getElementById('q').value = t; doSearch(t); };
    topicsEl.appendChild(btn);
  });

  document.getElementById('q').addEventListener('input', e => {
    clearTimeout(debounce);
    debounce = setTimeout(() => doSearch(e.target.value), 300);
  });

  function normalizeText(s) {
    return s.replace(/&rsquo;/g,"'").replace(/&ldquo;|&rdquo;/g,'"').replace(/&mdash;/g,'‚Äî').replace(/&amp;/g,'&').replace(/&nbsp;/g,' ').replace(/&#\d+;/g,'');
  }

  async function loadIndex() {
    if (searchIndex) return;
    document.getElementById('loading').style.display = 'block';
    const resp = await fetch('../search-index.json');
    searchIndex = await resp.json();
    document.getElementById('loading').style.display = 'none';
  }

  async function doSearch(query) {
    if (!query || query.length < 2) {
      document.getElementById('results').innerHTML = '';
      document.getElementById('count').textContent = '';
      return;
    }
    await loadIndex();

    const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 1);
    const scored = [];

    searchIndex.forEach(entry => {
      const text = normalizeText((entry.n||'') + ' ' + (entry.t||'') + ' ' + (entry.d||'')).toLowerCase();
      const title = normalizeText(entry.n||'').toLowerCase();
      
      let score = 0;
      let matchCount = 0;
      
      terms.forEach(term => {
        if (title.includes(term)) { score += 10; matchCount++; }
        else if (text.includes(term)) { score += 3; matchCount++; }
        // Exact phrase bonus
        if (terms.length > 1 && text.includes(terms.join(' '))) score += 20;
      });

      if (matchCount === 0) return;
      // Boost if all terms matched
      if (matchCount === terms.length) score += 15;
      // Category boosts
      if (entry.c === 'study') score += 5;
      if (entry.c === 'reference') score += 2;

      scored.push({ ...entry, score });
    });

    scored.sort((a,b) => b.score - a.score);
    
    // Group by category
    const groups = {};
    scored.slice(0, 200).forEach(r => {
      const cat = r.c || 'other';
      if (!groups[cat]) groups[cat] = [];
      groups[cat].push(r);
    });

    let html = '';
    CATEGORY_ORDER.forEach(cat => {
      if (!groups[cat]) return;
      const items = groups[cat].slice(0, 50);
      html += `<div class="result-group">
        <div class="group-label">${CATEGORY_LABELS[cat]||cat} (${groups[cat].length})</div>
        ${items.map(r => {
          const snippet = normalizeText(r.t || r.d || '').substring(0, 150);
          return `<div class="result-item">
            <a href="../${r.u}">${normalizeText(r.n||r.u)}</a>
            <span class="result-cat">${r.c||''}</span>
            ${snippet ? `<div class="result-snippet">${snippet}...</div>` : ''}
          </div>`;
        }).join('')}
      </div>`;
    });
    // Other categories
    Object.keys(groups).forEach(cat => {
      if (CATEGORY_ORDER.includes(cat)) return;
      const items = groups[cat].slice(0, 20);
      html += `<div class="result-group">
        <div class="group-label">${cat} (${groups[cat].length})</div>
        ${items.map(r => `<div class="result-item"><a href="../${r.u}">${normalizeText(r.n||r.u)}</a></div>`).join('')}
      </div>`;
    });

    document.getElementById('count').textContent = `${scored.length} results for "${query}"`;
    document.getElementById('results').innerHTML = html || '<p style="text-align:center;color:var(--text-faded)">No results found.</p>';
  }
  </script>

  <script src="../js/main.js"></script>
  <script src="../js/bg-music.js?v2"></script>
</body>
</html>
