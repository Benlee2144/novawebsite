<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cross-Reference Galaxy — The Unveiled Word</title>
<meta name="description" content="264,000 connections. 66 books. One galaxy. Explore every cross-reference in the Bible as an interactive 3D universe.">
<link rel="icon" href="../favicon.svg" type="image/svg+xml">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#010005;font-family:Georgia,serif}
canvas{position:fixed;top:0;left:0;width:100vw!important;height:100vh!important;display:block}

/* Cinematic intro */
#intro{position:fixed;inset:0;z-index:300;background:#010005;display:flex;flex-direction:column;
  align-items:center;justify-content:center;transition:opacity 2s}
#intro.gone{opacity:0;pointer-events:none}
#verse{color:rgba(197,150,12,0);font-style:italic;font-size:1.1rem;max-width:500px;text-align:center;
  line-height:1.8;transition:color 3s;letter-spacing:0.02em}
#verse.show{color:rgba(197,150,12,0.7)}
#verse cite{display:block;margin-top:12px;font-size:0.75rem;font-style:normal;color:rgba(197,150,12,0.4);
  letter-spacing:0.15em;text-transform:uppercase}
#skipbtn{position:fixed;bottom:30px;right:30px;z-index:301;color:rgba(255,245,220,0.2);font-size:0.65rem;
  cursor:pointer;letter-spacing:0.1em;border:none;background:none;font-family:Georgia,serif;
  transition:color 0.3s}
#skipbtn:hover{color:rgba(255,245,220,0.5)}

/* HUD */
#hud{position:fixed;top:0;left:0;right:0;z-index:100;pointer-events:none;
  padding:16px 20px;display:flex;justify-content:space-between;align-items:flex-start;
  opacity:0;transition:opacity 1.5s}
#hud.show{opacity:1}
#hud *{pointer-events:auto}
#hud a{color:rgba(197,150,12,0.4);text-decoration:none;font-size:0.7rem;transition:color 0.3s}
#hud a:hover{color:rgba(197,150,12,0.8)}
#htitle{color:rgba(197,150,12,0.5);font-size:0.7rem;letter-spacing:0.25em;text-transform:uppercase;
  font-family:'Cinzel',Georgia,serif}
#hstats{color:rgba(255,245,220,0.2);font-size:0.55rem;letter-spacing:0.08em;text-align:right}

/* Search */
#search-wrap{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:150;opacity:0;transition:opacity 1.5s}
#search-wrap.show{opacity:1}
#search{background:rgba(255,245,220,0.05);border:1px solid rgba(197,150,12,0.15);color:#fff5dc;
  font-family:Georgia,serif;font-size:0.75rem;padding:6px 14px;border-radius:20px;width:200px;
  outline:none;transition:border-color 0.3s,width 0.3s}
#search:focus{border-color:rgba(197,150,12,0.5);width:260px}
#search::placeholder{color:rgba(255,245,220,0.2)}
#search-results{position:absolute;top:36px;left:0;right:0;background:rgba(1,0,5,0.95);border:1px solid rgba(197,150,12,0.15);border-radius:8px;display:none;max-height:300px;overflow-y:auto}
#search-results.show{display:block}
#search-results div{padding:8px 14px;color:rgba(255,245,220,0.7);font-size:0.7rem;cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;transition:background 0.2s}
#search-results div:hover{background:rgba(197,150,12,0.1)}
#search-results div span.sec{color:rgba(197,150,12,0.3);font-size:0.6rem}

/* Info panel */
#panel{position:fixed;bottom:0;left:0;right:0;z-index:100;text-align:center;
  background:linear-gradient(0deg,rgba(1,0,5,0.97) 0%,rgba(1,0,5,0.85) 60%,rgba(1,0,5,0.4) 85%,transparent 100%);
  padding:30px 28px 28px;transform:translateY(110%);transition:transform 0.6s cubic-bezier(0.25,1,0.5,1);
  max-height:55vh;overflow-y:auto}
#panel.show{transform:translateY(0)}
#panel-close{position:absolute;top:10px;right:16px;background:none;border:none;color:rgba(255,245,220,0.3);
  font-size:1.2rem;cursor:pointer;transition:color 0.2s;font-family:Georgia}
#panel-close:hover{color:rgba(255,245,220,0.7)}
#bname{color:#c5960c;font-size:1.5rem;font-family:'Cinzel',Georgia,serif;margin-bottom:4px;
  text-shadow:0 0 30px rgba(197,150,12,0.3)}
#bdetail{color:rgba(255,245,220,0.5);font-size:0.75rem;margin-bottom:6px}
#bdesc{color:rgba(255,245,220,0.35);font-size:0.68rem;line-height:1.6;max-width:600px;margin:0 auto 12px;font-style:italic}
#bconns-title{color:rgba(197,150,12,0.4);font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px}
#bconns{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:12px}
.conn-chip{background:rgba(197,150,12,0.08);border:1px solid rgba(197,150,12,0.15);border-radius:16px;
  padding:4px 12px;font-size:0.62rem;color:rgba(255,245,220,0.6);cursor:pointer;transition:all 0.2s;
  white-space:nowrap}
.conn-chip:hover{background:rgba(197,150,12,0.2);border-color:rgba(197,150,12,0.4);color:#fff5dc}
.conn-chip .cnt{color:rgba(197,150,12,0.5);margin-left:4px;font-size:0.55rem}
#blink{margin-top:8px}
#blink a{color:rgba(197,150,12,0.4);font-size:0.6rem;text-decoration:none;letter-spacing:0.08em;
  border-bottom:1px solid rgba(197,150,12,0.15);padding-bottom:2px;transition:color 0.2s}
#blink a:hover{color:rgba(197,150,12,0.8)}

/* Strength indicator */
#strength-bar{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px}
#strength-bar .bar{width:120px;height:3px;background:rgba(255,245,220,0.05);border-radius:2px;overflow:hidden}
#strength-bar .fill{height:100%;background:linear-gradient(90deg,rgba(197,150,12,0.3),rgba(197,150,12,0.8));transition:width 0.6s}
#strength-bar .lbl{color:rgba(255,245,220,0.2);font-size:0.55rem}

/* Legend */
#legend{position:fixed;top:50px;right:16px;z-index:100;opacity:0;transition:opacity 1.5s 2s}
#legend.show{opacity:0.5}
#legend:hover{opacity:0.9}
#legend div{display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer;transition:opacity 0.2s}
#legend div:hover{opacity:1}
.ldot{width:6px;height:6px;border-radius:50%}
.llbl{color:rgba(255,245,220,0.6);font-size:0.5rem;letter-spacing:0.04em}

/* Hint */
#hint{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:99;
  color:rgba(255,245,220,0);font-size:0.6rem;letter-spacing:0.12em;
  transition:color 1.5s 4s;pointer-events:none}
#hint.show{color:rgba(255,245,220,0.2)}

/* Tooltip */
#tooltip{position:fixed;z-index:200;pointer-events:none;background:rgba(1,0,5,0.9);
  border:1px solid rgba(197,150,12,0.2);border-radius:6px;padding:6px 12px;
  color:rgba(255,245,220,0.8);font-size:0.65rem;display:none;white-space:nowrap;
  box-shadow:0 4px 20px rgba(0,0,0,0.5)}
#tooltip .tt-name{color:#c5960c;font-weight:bold;font-size:0.7rem}
#tooltip .tt-detail{color:rgba(255,245,220,0.4);font-size:0.55rem;margin-top:2px}

/* Connection strength legend */
#conn-legend{position:fixed;bottom:20px;right:16px;z-index:99;opacity:0;transition:opacity 1.5s 3s}
#conn-legend.show{opacity:0.35}
#conn-legend:hover{opacity:0.8}
.cl-title{color:rgba(255,245,220,0.4);font-size:0.5rem;letter-spacing:0.1em;margin-bottom:4px}
.cl-row{display:flex;align-items:center;gap:6px;margin-bottom:2px}
.cl-line{height:2px;width:30px;border-radius:1px}
.cl-lbl{color:rgba(255,245,220,0.4);font-size:0.45rem}

@media(max-width:768px){
  #verse{font-size:0.9rem;padding:0 24px}
  #legend{display:none}
  #conn-legend{display:none}
  #bname{font-size:1.2rem}
  #search{width:160px}
  #search:focus{width:200px}
  #panel{max-height:65vh}
}
</style>
</head>
<body>

<div id="intro">
  <p id="verse">
    &ldquo;In the beginning God created the heaven and the earth.
    And God said, Let there be light: and there was light.&rdquo;
    <cite>Genesis 1:1, 3</cite>
  </p>
</div>
<button id="skipbtn" onclick="skipIntro()">skip →</button>

<div id="hud">
  <a href="../">← The Unveiled Word</a>
  <div id="htitle">Cross-Reference Galaxy</div>
  <div id="hstats">66 Books · 264,673 References</div>
</div>

<div id="search-wrap">
  <input type="text" id="search" placeholder="Search books..." autocomplete="off">
  <div id="search-results"></div>
</div>

<div id="legend"></div>
<div id="conn-legend">
  <div class="cl-title">CONNECTION STRENGTH</div>
  <div class="cl-row"><div class="cl-line" style="background:rgba(255,245,220,0.7);height:3px"></div><span class="cl-lbl">1000+ refs</span></div>
  <div class="cl-row"><div class="cl-line" style="background:rgba(255,245,220,0.3);height:2px"></div><span class="cl-lbl">500-999</span></div>
  <div class="cl-row"><div class="cl-line" style="background:rgba(255,245,220,0.1);height:1px"></div><span class="cl-lbl">&lt;500</span></div>
</div>

<canvas id="c"></canvas>

<div id="panel">
  <button id="panel-close" onclick="deselect()">✕</button>
  <div id="bname"></div>
  <div id="bdetail"></div>
  <div id="strength-bar"><span class="lbl">Connectivity</span><div class="bar"><div class="fill" id="str-fill"></div></div><span class="lbl" id="str-num"></span></div>
  <div id="bdesc"></div>
  <div id="bconns-title">STRONGEST CONNECTIONS</div>
  <div id="bconns"></div>
  <div id="blink"></div>
</div>

<div id="tooltip"><div class="tt-name"></div><div class="tt-detail"></div></div>
<div id="hint">drag to orbit · scroll to zoom · click a star · press Esc to deselect</div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>
<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';
import {ShaderPass} from 'three/addons/postprocessing/ShaderPass.js';

// Book descriptions for the info panel
const BOOK_INFO = {
  Gen:"The beginning of everything — creation, the fall, the flood, and God's covenant with Abraham. Foundation of all biblical theology.",
  Exod:"Israel's liberation from Egypt, the giving of the Law at Sinai, and the construction of the Tabernacle. The defining event of the Old Testament.",
  Lev:"Instructions for worship, sacrifice, and holiness. The priesthood manual that shaped Israel's identity as a holy nation.",
  Num:"Israel's 40 years wandering the wilderness. Census records, rebellion, and the journey toward the Promised Land.",
  Deut:"Moses' farewell speeches. A second giving of the Law and a covenant renewal before Israel enters Canaan.",
  Josh:"The conquest and settlement of Canaan. Joshua leads Israel into the land God promised Abraham.",
  Judg:"A cycle of rebellion, oppression, and deliverance. Israel's darkest period before the monarchy.",
  Ruth:"A Moabite widow's loyalty leads her into the lineage of King David — and ultimately Jesus.",
  '1Sam':"The transition from judges to kings. Samuel, Saul's tragic reign, and David's rise.",
  '2Sam':"David's reign over united Israel — military victories, the Bathsheba affair, and family turmoil.",
  '1Kgs':"Solomon's glory and the kingdom's division. Elijah confronts Baal worship in the northern kingdom.",
  '2Kgs':"The decline of both kingdoms. Elisha's ministry, Assyria conquers Israel, Babylon conquers Judah.",
  '1Chr':"Israel's history retold from a priestly perspective, focusing on David's preparations for the Temple.",
  '2Chr':"Solomon's Temple, Judah's kings, and the exile to Babylon. Ends with Cyrus' decree to rebuild.",
  Ezra:"The return from exile. Rebuilding the Temple and restoring proper worship in Jerusalem.",
  Neh:"Rebuilding Jerusalem's walls. Nehemiah's leadership and spiritual reforms after exile.",
  Esth:"A Jewish queen saves her people from genocide. God's hidden providence in a pagan empire.",
  Job:"The problem of suffering explored through poetry. God answers from the whirlwind.",
  Ps:"150 songs and prayers covering every human emotion — worship, lament, praise, and prophecy.",
  Prov:"Practical wisdom for daily life. The fear of the LORD is the beginning of knowledge.",
  Eccl:"The Preacher's search for meaning. 'Vanity of vanities' — life under the sun without God.",
  Song:"A love poem celebrating the beauty of romantic love. Read as human love and divine allegory.",
  Isa:"The prophet of salvation. Messianic prophecies, judgment oracles, and the Suffering Servant songs.",
  Jer:"The weeping prophet warns Judah of coming destruction. Calls for repentance; promises a new covenant.",
  Lam:"Five poems mourning Jerusalem's destruction by Babylon. Raw grief and stubborn hope.",
  Ezek:"Visions of God's glory, judgment on nations, and the valley of dry bones. A future Temple described.",
  Dan:"Faithfulness in exile. Apocalyptic visions of empires rising and falling, and God's eternal kingdom.",
  Hos:"God's love for unfaithful Israel, illustrated through Hosea's marriage to Gomer.",
  Joel:"The Day of the LORD — locust plague as warning, and the promise of the Spirit poured out.",
  Amos:"A shepherd-prophet denounces social injustice. 'Let justice roll down like waters.'",
  Obad:"The shortest Old Testament book. Judgment against Edom for betraying Israel.",
  Jonah:"A reluctant prophet, a great fish, and God's mercy extending to Israel's enemies.",
  Mic:"Justice, mercy, and walking humbly with God. Predicts the Messiah's birth in Bethlehem.",
  Nah:"The fall of Nineveh — God's judgment on Assyria's cruelty.",
  Hab:"A prophet questions God about evil and injustice. 'The righteous shall live by faith.'",
  Zeph:"The coming Day of the LORD — universal judgment and a promised remnant.",
  Hag:"After exile: rebuild the Temple. Stop neglecting God's house for your own.",
  Zech:"Apocalyptic visions and Messianic prophecies. The coming King rides on a donkey.",
  Mal:"The last Old Testament prophet. Corruption in worship, the coming messenger, and 400 years of silence.",
  Matt:"Jesus as the promised Jewish Messiah. The Sermon on the Mount, parables, and the Great Commission.",
  Mark:"The action Gospel — Jesus as the suffering servant. Fast-paced, vivid, written for Roman readers.",
  Luke:"The most detailed Gospel. Jesus for all people — outcasts, women, Gentiles, the poor.",
  John:"The theological Gospel. 'In the beginning was the Word.' Seven signs pointing to Jesus as God.",
  Acts:"The birth and spread of the early church. The Holy Spirit, Peter, Paul, and the gospel going global.",
  Rom:"Paul's theological masterpiece. Justification by faith, the human condition, and life in the Spirit.",
  '1Cor':"Paul addresses a divided, morally compromised church. Love, gifts, resurrection, and unity.",
  '2Cor':"Paul defends his apostleship. Weakness as strength, generosity, and the ministry of reconciliation.",
  Gal:"Freedom from the Law. Justification by faith alone — Paul's most passionate letter.",
  Eph:"The cosmic Christ, the church as his body, spiritual warfare, and unity in diversity.",
  Phil:"Joy in all circumstances. Written from prison — 'to live is Christ, to die is gain.'",
  Col:"Christ is supreme over all creation. Don't be captured by hollow philosophy.",
  '1Thess':"Encouragement to a young church. The return of Christ and living in readiness.",
  '2Thess':"Clarifying the Day of the Lord. Stand firm; don't be idle.",
  '1Tim':"Instructions for church leadership. Fight the good fight of faith.",
  '2Tim':"Paul's final letter. 'I have fought the good fight, I have finished the race.'",
  Titus:"Organizing the church in Crete. Sound doctrine and good works.",
  Phlm:"A personal letter about a runaway slave. Forgiveness, reconciliation, and Christian brotherhood.",
  Heb:"Christ is superior to everything — angels, Moses, the priesthood, the old covenant.",
  Jas:"Faith without works is dead. Practical Christian living — taming the tongue, caring for the poor.",
  '1Pet':"Suffering with hope. Elect exiles living as strangers in a hostile world.",
  '2Pet':"Warning against false teachers. The Day of the Lord is coming — live holy lives.",
  '1John':"God is light, God is love. Tests for authentic faith — belief, love, and obedience.",
  '2John':"A brief letter warning against false teachers. Walk in truth and love.",
  '3John':"Commending hospitality and condemning Diotrephes' pride.",
  Jude:"Contend for the faith. Warning against infiltrators who distort grace.",
  Rev:"The apocalyptic vision — Christ's ultimate victory, the fall of evil, and the new heaven and earth."
};

// Approximate verse counts per book
const VERSES={Gen:1533,Exod:1213,Lev:859,Num:1288,Deut:959,Josh:658,Judg:618,Ruth:85,'1Sam':810,'2Sam':695,
'1Kgs':816,'2Kgs':719,'1Chr':942,'2Chr':822,Ezra:280,Neh:406,Esth:167,Job:1070,Ps:2461,Prov:915,Eccl:222,
Song:117,Isa:1292,Jer:1364,Lam:154,Ezek:1273,Dan:357,Hos:197,Joel:73,Amos:146,Obad:21,Jonah:48,Mic:105,
Nah:47,Hab:56,Zeph:53,Hag:38,Zech:211,Mal:55,Matt:1071,Mark:678,Luke:1151,John:879,Acts:1007,Rom:433,
'1Cor':437,'2Cor':257,Gal:149,Eph:155,Phil:104,Col:95,'1Thess':89,'2Thess':47,'1Tim':113,'2Tim':83,Titus:46,
Phlm:25,Heb:303,Jas:108,'1Pet':105,'2Pet':61,'1John':105,'2John':13,'3John':15,Jude:25,Rev:404};

const C={
  'Torah':0xd4a843,'History':0x9e7a2e,'Poetry':0x6bb5ff,
  'Major Prophets':0xef5555,'Minor Prophets':0xe08850,
  'Gospels':0xfff0c8,'Church History':0x4dd88a,
  "Paul's Letters":0xb16dea,'General Letters':0x3dd88a,'Apocalyptic':0xff4444
};

let scene,camera,renderer,composer,controls,clock;
let books=[],glows=[],labels=[],conns=[];
let flowParticles=[];
let shootingStars;
let selected=null,selectedIdx=-1,hovered=null;
let raycaster=new THREE.Raycaster(),mouse=new THREE.Vector2();
let data,introPhase=0,introTime=0;
let audioCtx,masterGain;
let hitSpheres=[]; // invisible larger spheres for click detection

// ═══════════════════════════════════════════════
// PROCEDURAL TEXTURES
// ═══════════════════════════════════════════════
function starTex(){
  const c=document.createElement('canvas'),s=256;c.width=c.height=s;
  const x=c.getContext('2d'),h=s/2;
  let g=x.createRadialGradient(h,h,0,h,h,h);
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(0.02,'rgba(255,252,240,0.95)');
  g.addColorStop(0.06,'rgba(255,240,210,0.6)');
  g.addColorStop(0.15,'rgba(255,220,160,0.2)');
  g.addColorStop(0.35,'rgba(200,160,80,0.04)');
  g.addColorStop(0.6,'rgba(120,80,40,0.01)');
  g.addColorStop(1,'rgba(0,0,0,0)');
  x.fillStyle=g;x.fillRect(0,0,s,s);
  x.globalCompositeOperation='lighter';
  for(let a=0;a<6;a++){
    const ang=a*Math.PI/3;
    x.save();x.translate(h,h);x.rotate(ang);
    let sg=x.createLinearGradient(-h,0,h,0);
    sg.addColorStop(0,'rgba(255,255,255,0)');
    sg.addColorStop(0.35,'rgba(255,240,200,0.03)');
    sg.addColorStop(0.48,'rgba(255,255,255,0.1)');
    sg.addColorStop(0.5,'rgba(255,255,255,0.15)');
    sg.addColorStop(0.52,'rgba(255,255,255,0.1)');
    sg.addColorStop(0.65,'rgba(255,240,200,0.03)');
    sg.addColorStop(1,'rgba(255,255,255,0)');
    x.fillStyle=sg;x.fillRect(-h,-1.5,s,3);
    x.restore();
  }
  const t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearFilter;return t;
}

// ═══════════════════════════════════════════════
// AMBIENT AUDIO
// ═══════════════════════════════════════════════
function initAudio(){
  try{
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain();
    masterGain.gain.value=0;
    masterGain.connect(audioCtx.destination);
    [55,82.5,110,165].forEach((freq,i)=>{
      const osc=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      osc.type='sine';osc.frequency.value=freq;
      g.gain.value=[0.06,0.03,0.02,0.01][i];
      osc.connect(g);g.connect(masterGain);osc.start();
    });
    masterGain.gain.linearRampToValueAtTime(0.4,audioCtx.currentTime+6);
  }catch(e){}
}

function playChime(freq){
  if(!audioCtx)return;
  try{
    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    osc.type='sine';osc.frequency.value=freq;
    g.gain.value=0.08;
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+2);
    osc.connect(g);g.connect(masterGain);osc.start();osc.stop(audioCtx.currentTime+2);
  }catch(e){}
}

// ═══════════════════════════════════════════════
// CUSTOM LINE SHADER (for thick glowing lines)
// ═══════════════════════════════════════════════
function createGlowLine(points, color1, color2, opacity, thickness){
  // Use a tube for thick visible lines
  const curve = new THREE.CatmullRomCurve3(points);
  const tubeGeo = new THREE.TubeGeometry(curve, 24, thickness, 6, false);
  const col = new THREE.Color(color1).lerp(new THREE.Color(color2), 0.5);
  const mat = new THREE.MeshBasicMaterial({
    color: col,
    transparent: true,
    opacity: opacity,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });
  return new THREE.Mesh(tubeGeo, mat);
}

// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════
async function init(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,3000);
  camera.position.set(0,0,0.1);

  renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true,powerPreference:'high-performance'});
  const dpr=Math.min(devicePixelRatio,2);
  renderer.setPixelRatio(dpr);
  renderer.setSize(window.innerWidth,window.innerHeight,false);
  renderer.domElement.style.width=window.innerWidth+'px';
  renderer.domElement.style.height=window.innerHeight+'px';
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=0.9;

  composer=new EffectComposer(renderer);
  composer.addPass(new RenderPass(scene,camera));

  const bloom=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),1.8,0.8,0.2);
  composer.addPass(bloom);

  const filmShader={
    uniforms:{tDiffuse:{value:null},uTime:{value:0},uVignette:{value:0.35}},
    vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
    fragmentShader:`uniform sampler2D tDiffuse;uniform float uTime,uVignette;varying vec2 vUv;
      float rand(vec2 co){return fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453);}
      void main(){
        vec4 col=texture2D(tDiffuse,vUv);
        float grain=rand(vUv*uTime)*0.02;col.rgb+=grain-0.01;
        float d=distance(vUv,vec2(0.5));col.rgb*=smoothstep(0.85,0.3,d*uVignette*2.0);
        col.r+=col.r*0.04;col.b+=max(0.0,(0.15-col.r))*0.08;
        gl_FragColor=col;}`
  };
  composer.addPass(new ShaderPass(filmShader));

  controls=new OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;controls.dampingFactor=0.03;
  controls.rotateSpeed=0.3;controls.zoomSpeed=0.5;
  controls.minDistance=8;controls.maxDistance=400;
  controls.autoRotate=true;controls.autoRotateSpeed=0.08;
  controls.enabled=false;

  const resp=await fetch('../data/galaxy_data.json');
  data=await resp.json();

  buildSpace();
  buildBooks();
  buildConnections();
  buildShootingStars();
  buildLegend();
  initSearch();

  addEventListener('resize',onResize);
  addEventListener('orientationchange',()=>setTimeout(onResize,200));
  // iOS Safari viewport fix: force correct size after load
  setTimeout(onResize,100);
  addEventListener('keydown',onKey);
  renderer.domElement.addEventListener('click',onClick);
  renderer.domElement.addEventListener('mousemove',onHover);
  renderer.domElement.addEventListener('touchend',onTouch,{passive:true});

  clock=new THREE.Clock();
  introPhase=1;
  requestAnimationFrame(animate);
}

// ═══════════════════════════════════════════════
// DEEP SPACE
// ═══════════════════════════════════════════════
function buildSpace(){
  const N=8000,p=new Float32Array(N*3),s=new Float32Array(N),c=new Float32Array(N*3);
  for(let i=0;i<N;i++){
    const th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1),r=400+Math.random()*800;
    p[i*3]=r*Math.sin(ph)*Math.cos(th);p[i*3+1]=r*Math.sin(ph)*Math.sin(th);p[i*3+2]=r*Math.cos(ph);
    s[i]=Math.random()*1.5+0.2;
    const temp=Math.random();
    c[i*3]=0.9+temp*0.1;c[i*3+1]=0.85+temp*0.1;c[i*3+2]=0.8+temp*0.15;
  }
  const bg=new THREE.BufferGeometry();
  bg.setAttribute('position',new THREE.BufferAttribute(p,3));
  bg.setAttribute('size',new THREE.BufferAttribute(s,1));
  bg.setAttribute('color',new THREE.BufferAttribute(c,3));
  const bm=new THREE.ShaderMaterial({
    uniforms:{uTime:{value:0},uPR:{value:renderer.getPixelRatio()}},
    vertexShader:`attribute float size;varying vec3 vC;varying float vTw;uniform float uTime,uPR;
      void main(){vC=color;vTw=sin(uTime*2.0+position.x*0.03+position.z*0.03)*0.4+0.6;
      vec4 mv=modelViewMatrix*vec4(position,1.0);gl_Position=projectionMatrix*mv;
      gl_PointSize=size*uPR*(80.0/-mv.z);}`,
    fragmentShader:`varying vec3 vC;varying float vTw;
      void main(){float d=length(gl_PointCoord-0.5);if(d>0.5)discard;
      gl_FragColor=vec4(vC,smoothstep(0.5,0.0,d)*vTw*0.7);}`,
    transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,vertexColors:true
  });
  scene.add(new THREE.Points(bg,bm));

  // Nebula
  const nn=15000,np=new Float32Array(nn*3),nc=new Float32Array(nn*3),ns=new Float32Array(nn);
  for(let i=0;i<nn;i++){
    const arm=Math.floor(Math.random()*3);
    const armOff=arm*(Math.PI*2/3);
    const dist=Math.random()*200+5;
    const angle=armOff+dist*0.025+Math.random()*0.4;
    const spread=12+dist*0.12;
    np[i*3]=Math.cos(angle)*dist+(Math.random()-0.5)*spread;
    np[i*3+1]=(Math.random()-0.5)*25*Math.exp(-dist*0.005);
    np[i*3+2]=Math.sin(angle)*dist+(Math.random()-0.5)*spread;
    const t=Math.random();
    const dustAngle=Math.atan2(np[i*3+2],np[i*3]);
    const dustFactor=Math.abs(Math.sin(dustAngle*2))<0.15?0.1:1;
    if(t<0.5){nc[i*3]=0.35*dustFactor;nc[i*3+1]=0.18*dustFactor;nc[i*3+2]=0.05*dustFactor;}
    else if(t<0.8){nc[i*3]=0.12*dustFactor;nc[i*3+1]=0.1*dustFactor;nc[i*3+2]=0.3*dustFactor;}
    else{nc[i*3]=0.2*dustFactor;nc[i*3+1]=0.08*dustFactor;nc[i*3+2]=0.12*dustFactor;}
    ns[i]=Math.random()*5+1;
  }
  const ng=new THREE.BufferGeometry();
  ng.setAttribute('position',new THREE.BufferAttribute(np,3));
  ng.setAttribute('color',new THREE.BufferAttribute(nc,3));
  ng.setAttribute('size',new THREE.BufferAttribute(ns,1));
  const nm=new THREE.ShaderMaterial({
    uniforms:{uTime:{value:0},uPR:{value:renderer.getPixelRatio()}},
    vertexShader:`attribute float size;varying vec3 vC;uniform float uTime,uPR;
      void main(){vC=color;vec3 p=position;
      p.y+=sin(uTime*0.06+position.x*0.005)*2.0;
      p.x+=cos(uTime*0.03+position.z*0.003)*1.5;
      vec4 mv=modelViewMatrix*vec4(p,1.0);gl_Position=projectionMatrix*mv;
      gl_PointSize=size*uPR*(250.0/-mv.z);}`,
    fragmentShader:`varying vec3 vC;
      void main(){float d=length(gl_PointCoord-0.5);if(d>0.5)discard;
      gl_FragColor=vec4(vC,smoothstep(0.5,0.05,d)*0.04);}`,
    transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,vertexColors:true
  });
  const neb=new THREE.Points(ng,nm);neb.userData.type='nebula';
  scene.add(neb);
}

// ═══════════════════════════════════════════════
// SHOOTING STARS
// ═══════════════════════════════════════════════
function buildShootingStars(){
  const N=6;
  const geo=new THREE.BufferGeometry();
  const pos=new Float32Array(N*6);
  const vel=[];
  for(let i=0;i<N;i++){
    pos[i*6]=pos[i*6+3]=(Math.random()-0.5)*600;
    pos[i*6+1]=pos[i*6+4]=Math.random()*200+50;
    pos[i*6+2]=pos[i*6+5]=(Math.random()-0.5)*600;
    vel.push({x:(Math.random()-0.5)*8,y:-(Math.random()*3+2),z:(Math.random()-0.5)*8,
      life:0,maxLife:Math.random()*1.5+0.5,cooldown:Math.random()*15+5});
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const mat=new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:0,blending:THREE.AdditiveBlending,depthWrite:false});
  shootingStars={geo,pos,vel,mesh:new THREE.LineSegments(geo,mat)};
  scene.add(shootingStars.mesh);
}

// ═══════════════════════════════════════════════
// BOOKS
// ═══════════════════════════════════════════════
function buildBooks(){
  const tex=starTex();
  const secs=Object.keys(data.sections);
  const majorBooks=['Gen','Ps','Isa','Matt','Rev','Rom','Exod','Jer','Ezek','John','Heb'];

  data.books.forEach((bk,i)=>{
    const si=secs.indexOf(bk.section);
    const arr=data.sections[bk.section];
    const bi=arr.indexOf(bk.abbr);
    const bn=arr.length;

    const arm=si%3;
    const armBase=arm*(Math.PI*2/3);
    const progress=(si*bn+bi)/(data.books.length);
    const dist=25+progress*130;
    const angle=armBase+progress*Math.PI*3.5+(bi/bn)*0.6;
    const y=Math.sin(angle*1.8)*10+(Math.random()-0.5)*6;
    const x=Math.cos(angle)*dist;
    const z=Math.sin(angle)*dist;

    const sz=Math.max(0.3,Math.pow(bk.chapters,0.3)*0.35);
    const col=C[bk.section]||0xc5960c;

    // Core mesh
    const core=new THREE.Mesh(
      new THREE.SphereGeometry(sz*0.5,12,12),
      new THREE.MeshBasicMaterial({color:0xffffff})
    );
    core.position.set(x,y,z);
    core.userData={bk,idx:i,sz};
    scene.add(core);books.push(core);

    // Invisible hit sphere (much larger for easier clicking)
    const hitSphere=new THREE.Mesh(
      new THREE.SphereGeometry(sz*4,8,8),
      new THREE.MeshBasicMaterial({visible:false})
    );
    hitSphere.position.copy(core.position);
    hitSphere.userData={idx:i,isHit:true};
    scene.add(hitSphere);hitSpheres.push(hitSphere);

    // Star glow sprite
    const gm=new THREE.SpriteMaterial({
      map:tex,color:col,transparent:true,opacity:0.7,
      blending:THREE.AdditiveBlending,depthWrite:false
    });
    const glow=new THREE.Sprite(gm);
    const gs=sz*8+2;
    glow.scale.set(gs,gs,1);glow.position.copy(core.position);
    glow.userData={idx:i,bs:gs,bo:0.7};
    scene.add(glow);glows.push(glow);

    // Orbital ring for major books
    if(majorBooks.includes(bk.abbr)){
      const rg=new THREE.RingGeometry(sz*4,sz*4.3,48);
      const rm=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.12,side:THREE.DoubleSide,blending:THREE.AdditiveBlending,depthWrite:false});
      const ring=new THREE.Mesh(rg,rm);
      ring.position.copy(core.position);ring.rotation.x=Math.PI*0.4;
      ring.userData={type:'ring',idx:i};
      scene.add(ring);
    }

    // Always-visible label for major books
    const lbl=mkLbl(bk.name, majorBooks.includes(bk.abbr));
    lbl.position.set(x,y+sz*5+2.5,z);
    lbl.material.opacity=majorBooks.includes(bk.abbr)?0.5:0;
    lbl.userData={idx:i,type:'label',isMajor:majorBooks.includes(bk.abbr)};
    scene.add(lbl);labels.push(lbl);
  });
}

function mkLbl(t, isMajor){
  const c=document.createElement('canvas');c.width=256;c.height=48;
  const x=c.getContext('2d');
  x.font=(isMajor?'600':'500')+' 18px Georgia,serif';x.textAlign='center';x.textBaseline='middle';
  x.shadowColor='rgba(0,0,0,1)';x.shadowBlur=6;
  x.fillStyle=isMajor?'rgba(255,245,220,1)':'rgba(255,245,220,0.9)';
  x.fillText(t,128,24);
  const tex=new THREE.CanvasTexture(c);tex.minFilter=THREE.LinearFilter;
  const s=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true,depthWrite:false}));
  s.scale.set(9,1.8,1);return s;
}

// ═══════════════════════════════════════════════
// CONNECTIONS — NOW ACTUALLY VISIBLE
// ═══════════════════════════════════════════════
function buildConnections(){
  // Show ALL 2036 connections, not just 500
  const all=data.connections;
  const max=all[0]?.count||1;

  all.forEach(cn=>{
    const fb=data.books.find(b=>b.abbr===cn.from);
    const tb=data.books.find(b=>b.abbr===cn.to);
    if(!fb||!tb)return;
    const fm=books[fb.index],tm=books[tb.index];

    const str=cn.count/max;
    const s=fm.position.clone(),e=tm.position.clone();
    const m=s.clone().add(e).multiplyScalar(0.5);
    m.y+=4+str*14;

    const curve=new THREE.QuadraticBezierCurve3(s,m,e);
    const pts=curve.getPoints(24);

    const c1=new THREE.Color(C[fb.section]||0xc5960c);
    const c2=new THREE.Color(C[tb.section]||0xc5960c);

    let line;
    if(str > 0.15){
      // TOP connections: use tube geometry for visible thickness
      const thickness = 0.04 + str * 0.2;
      const opacity = 0.15 + str * 0.6;
      const catmull = new THREE.CatmullRomCurve3(pts);
      const tubeGeo = new THREE.TubeGeometry(catmull, 20, thickness, 5, false);
      const col = c1.clone().lerp(c2, 0.5);
      const mat = new THREE.MeshBasicMaterial({
        color: col,
        transparent: true,
        opacity: opacity,
        blending: THREE.AdditiveBlending,
        depthWrite: false
      });
      line = new THREE.Mesh(tubeGeo, mat);
    } else {
      // Weaker connections: standard lines but still visible
      const geo=new THREE.BufferGeometry().setFromPoints(pts);
      const vc=new Float32Array(pts.length*3);
      for(let j=0;j<pts.length;j++){
        const t=j/(pts.length-1);
        const cc=c1.clone().lerp(c2,t);
        vc[j*3]=cc.r;vc[j*3+1]=cc.g;vc[j*3+2]=cc.b;
      }
      geo.setAttribute('color',new THREE.BufferAttribute(vc,3));
      const bo=0.03+str*0.3;
      const mat=new THREE.LineBasicMaterial({
        vertexColors:true,transparent:true,opacity:bo,
        blending:THREE.AdditiveBlending,depthWrite:false
      });
      line=new THREE.Line(geo,mat);
    }
    line.userData={from:cn.from,to:cn.to,count:cn.count,bo:line.material.opacity,curve,str};
    scene.add(line);conns.push(line);
  });
}

// ═══════════════════════════════════════════════
// ENERGY FLOW PARTICLES
// ═══════════════════════════════════════════════
function spawnFlow(bookAbbr){
  clearFlow();
  const related=conns.filter(l=>l.userData.from===bookAbbr||l.userData.to===bookAbbr)
    .sort((a,b)=>b.userData.count-a.userData.count).slice(0,40);
  related.forEach(line=>{
    const curve=line.userData.curve;
    if(!curve)return;
    const col=new THREE.Color(C[data.books.find(b=>b.abbr===bookAbbr)?.section]||0xc5960c);
    const particleCount=Math.min(12, 4+Math.floor(line.userData.str*10));
    for(let i=0;i<particleCount;i++){
      const geo=new THREE.SphereGeometry(0.2,6,6);
      const mat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.9,blending:THREE.AdditiveBlending});
      const m=new THREE.Mesh(geo,mat);
      m.userData={curve,t:Math.random(),speed:0.2+Math.random()*0.4,reverse:line.userData.to===bookAbbr};
      scene.add(m);flowParticles.push(m);
    }
  });
}

function clearFlow(){
  flowParticles.forEach(p=>{scene.remove(p);p.geometry.dispose();p.material.dispose()});
  flowParticles=[];
}

function updateFlow(dt){
  flowParticles.forEach(p=>{
    p.userData.t+=dt*p.userData.speed*(p.userData.reverse?-1:1);
    if(p.userData.t>1)p.userData.t-=1;
    if(p.userData.t<0)p.userData.t+=1;
    const pt=p.userData.curve.getPoint(p.userData.t);
    p.position.copy(pt);
    p.material.opacity=0.3+Math.sin(p.userData.t*Math.PI)*0.6;
  });
}

// ═══════════════════════════════════════════════
// LEGEND
// ═══════════════════════════════════════════════
function buildLegend(){
  const el=document.getElementById('legend');
  for(const[n,col] of Object.entries(C)){
    const d=document.createElement('div');
    const dot=document.createElement('span');dot.className='ldot';
    const hex='#'+new THREE.Color(col).getHexString();
    dot.style.background=hex;
    dot.style.boxShadow='0 0 6px '+hex;
    const lbl=document.createElement('span');lbl.className='llbl';lbl.textContent=n;
    d.append(dot,lbl);
    d.onclick=()=>highlightSection(n);
    el.appendChild(d);
  }
}

function highlightSection(secName){
  if(selected) deselect();
  const secBooks=data.sections[secName]||[];
  const secSet=new Set(secBooks);
  glows.forEach(g=>{
    const bk=data.books[g.userData.idx];
    if(secSet.has(bk.abbr)){g.material.opacity=1;g.scale.setScalar(g.userData.bs*1.5);}
    else{g.material.opacity=0.05;}
  });
  labels.forEach(l=>{
    const bk=data.books[l.userData.idx];
    l.material.opacity=secSet.has(bk.abbr)?0.9:0;
  });
  conns.forEach(l=>{
    const hasFrom=secSet.has(l.userData.from),hasTo=secSet.has(l.userData.to);
    if(hasFrom&&hasTo) l.material.opacity=l.userData.bo*2;
    else if(hasFrom||hasTo) l.material.opacity=l.userData.bo*0.5;
    else l.material.opacity=0.003;
  });
  // Auto-reset after 5s
  setTimeout(()=>{
    if(!selected){
      conns.forEach(l=>l.material.opacity=l.userData.bo);
      glows.forEach(g=>{g.material.opacity=g.userData.bo;g.scale.setScalar(g.userData.bs)});
      labels.forEach(l=>l.material.opacity=l.userData.isMajor?0.5:0);
    }
  },5000);
}

// ═══════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════
function initSearch(){
  const input=document.getElementById('search');
  const results=document.getElementById('search-results');
  input.addEventListener('input',()=>{
    const q=input.value.toLowerCase().trim();
    if(!q){results.classList.remove('show');return;}
    const matches=data.books.filter(b=>b.name.toLowerCase().includes(q)||b.abbr.toLowerCase().includes(q));
    if(!matches.length){results.classList.remove('show');return;}
    results.innerHTML='';
    matches.forEach(b=>{
      const d=document.createElement('div');
      d.innerHTML=`${b.name}<span class="sec">${b.section}</span>`;
      d.onclick=()=>{selectBook(b.index);input.value='';results.classList.remove('show');input.blur();};
      results.appendChild(d);
    });
    results.classList.add('show');
  });
  input.addEventListener('blur',()=>setTimeout(()=>results.classList.remove('show'),200));
  input.addEventListener('keydown',e=>{if(e.key==='Escape'){input.value='';results.classList.remove('show');input.blur();}});
}

// ═══════════════════════════════════════════════
// INTRO
// ═══════════════════════════════════════════════
function updateIntro(t){
  if(introPhase===0)return;
  if(introPhase===1){
    if(t>0.5) document.getElementById('verse').classList.add('show');
    if(t>4){introPhase=2;introTime=t;}
  }
  if(introPhase===2){
    if(t-introTime>2){introPhase=3;introTime=t;}
  }
  if(introPhase===3){
    const p=Math.min(1,(t-introTime)/4);
    const ease=1-Math.pow(1-p,3);
    camera.position.set(0,ease*60,ease*160);
    controls.target.set(0,0,0);
    renderer.toneMappingExposure=0.9*ease;
    if(p>0.3){
      document.getElementById('intro').classList.add('gone');
      document.getElementById('skipbtn').style.display='none';
    }
    if(p>0.7){
      document.getElementById('hud').classList.add('show');
      document.getElementById('legend').classList.add('show');
      document.getElementById('hint').classList.add('show');
      document.getElementById('search-wrap').classList.add('show');
      document.getElementById('conn-legend').classList.add('show');
    }
    if(p>=1){introPhase=0;controls.enabled=true;initAudio();}
  }
}

window.skipIntro=function(){
  introPhase=0;
  camera.position.set(0,60,160);controls.target.set(0,0,0);
  renderer.toneMappingExposure=0.9;controls.enabled=true;
  document.getElementById('intro').classList.add('gone');
  document.getElementById('skipbtn').style.display='none';
  document.getElementById('hud').classList.add('show');
  document.getElementById('legend').classList.add('show');
  document.getElementById('hint').classList.add('show');
  document.getElementById('search-wrap').classList.add('show');
  document.getElementById('conn-legend').classList.add('show');
  initAudio();
};

// ═══════════════════════════════════════════════
// INTERACTION
// ═══════════════════════════════════════════════
function onClick(e){
  if(introPhase)return;
  mouse.x=(e.clientX/innerWidth)*2-1;mouse.y=-(e.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(hitSpheres);
  if(hits.length){
    const idx=hits[0].object.userData.idx;
    if(selectedIdx===idx) deselect(); // Click same book = deselect
    else selectBook(idx);
  } else {
    deselect();
  }
}

function onTouch(e){
  if(introPhase||!e.changedTouches.length)return;
  const t=e.changedTouches[0];
  mouse.x=(t.clientX/innerWidth)*2-1;mouse.y=-(t.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(hitSpheres);
  if(hits.length){
    const idx=hits[0].object.userData.idx;
    if(selectedIdx===idx) deselect();
    else selectBook(idx);
  } else {
    deselect();
  }
}

function onHover(e){
  if(introPhase)return;
  mouse.x=(e.clientX/innerWidth)*2-1;mouse.y=-(e.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(hitSpheres);
  const tooltip=document.getElementById('tooltip');
  if(hits.length){
    const idx=hits[0].object.userData.idx;
    if(hovered!==idx){
      if(hovered!==null&&hovered!==selectedIdx&&!labels[hovered].userData.isMajor) labels[hovered].material.opacity=0;
      labels[idx].material.opacity=0.9;
      hovered=idx;
    }
    // Show tooltip
    const bk=data.books[idx];
    const bkConns=data.connections.filter(c=>c.from===bk.abbr||c.to===bk.abbr);
    const total=bkConns.reduce((s,c)=>s+c.count,0);
    tooltip.querySelector('.tt-name').textContent=bk.name;
    tooltip.querySelector('.tt-detail').textContent=`${bk.chapters} ch · ${(VERSES[bk.abbr]||0).toLocaleString()} verses · ${total.toLocaleString()} refs`;
    tooltip.style.display='block';
    tooltip.style.left=(e.clientX+15)+'px';
    tooltip.style.top=(e.clientY-10)+'px';
    renderer.domElement.style.cursor='pointer';
  }else{
    if(hovered!==null&&hovered!==selectedIdx&&!labels[hovered]?.userData.isMajor) labels[hovered].material.opacity=0;
    hovered=null;
    tooltip.style.display='none';
    renderer.domElement.style.cursor='grab';
  }
}

function onKey(e){
  if(e.key==='Escape') deselect();
}

function selectBook(idx){
  const bk=data.books[idx],mesh=books[idx];
  if(selectedIdx===idx) return; // Already selected
  if(selected) deselect(true); // silent deselect before reselect
  selected=mesh;selectedIdx=idx;controls.autoRotate=false;

  // Camera — zoom to book but keep some distance
  const tgt=mesh.position.clone();
  const camDist=30;
  const dir=tgt.clone().sub(controls.target).normalize();
  const camPos=tgt.clone().add(dir.multiplyScalar(-camDist)).add(new THREE.Vector3(0,8,0));
  animCam(camPos,tgt);

  playChime([261.6,329.6,392.0,523.2][idx%4]);

  // Find connections
  const bkConns=data.connections.filter(c=>c.from===bk.abbr||c.to===bk.abbr).sort((a,b)=>b.count-a.count);
  const connSet=new Set(bkConns.map(c=>c.from===bk.abbr?c.to:c.from));
  const total=bkConns.reduce((s,c)=>s+c.count,0);

  // Highlight connections — make related ones BRIGHT
  conns.forEach(l=>{
    if(l.userData.from===bk.abbr||l.userData.to===bk.abbr){
      l.material.opacity=Math.min(0.9,l.userData.bo*5+0.15);
    } else {
      l.material.opacity=0.004;
    }
  });
  glows.forEach(g=>{
    const gi=g.userData.idx;
    if(gi===idx){g.material.opacity=1;g.scale.setScalar(g.userData.bs*2.5);}
    else if(connSet.has(data.books[gi]?.abbr)){g.material.opacity=0.7;g.scale.setScalar(g.userData.bs*1.3);}
    else{g.material.opacity=0.03;}
  });
  books.forEach((m,i)=>{
    m.material.color.setHex(i===idx?0xffffff:connSet.has(data.books[i].abbr)?0xdddddd:0x111111);
  });
  labels.forEach((l,i)=>{
    if(i===idx) l.material.opacity=1;
    else if(connSet.has(data.books[i]?.abbr)) l.material.opacity=0.6;
    else l.material.opacity=0;
  });

  spawnFlow(bk.abbr);

  // UI Panel
  const verses=VERSES[bk.abbr]||'?';
  const maxTotal=data.connections.reduce((mx,c)=>{
    const t=data.connections.filter(x=>x.from===c.from||x.to===c.from).reduce((s,x)=>s+x.count,0);
    return Math.max(mx,t);
  },1);

  document.getElementById('bname').textContent=bk.name;
  document.getElementById('bdetail').textContent=
    `${bk.chapters} chapters · ${verses.toLocaleString()} verses · ${bk.section} · ${total.toLocaleString()} cross-references`;
  document.getElementById('bdesc').textContent=BOOK_INFO[bk.abbr]||'';
  document.getElementById('str-fill').style.width=Math.min(100,total/200)+'%';
  document.getElementById('str-num').textContent=total.toLocaleString()+' refs';

  // Connected books as clickable chips
  const connsEl=document.getElementById('bconns');
  connsEl.innerHTML='';
  bkConns.slice(0,15).forEach(c=>{
    const other=c.from===bk.abbr?c.to:c.from;
    const otherBk=data.books.find(b=>b.abbr===other);
    if(!otherBk)return;
    const chip=document.createElement('span');chip.className='conn-chip';
    chip.innerHTML=`${otherBk.name}<span class="cnt">${c.count.toLocaleString()}</span>`;
    chip.style.borderColor='#'+new THREE.Color(C[otherBk.section]||0xc5960c).getHexString()+'44';
    chip.onclick=()=>selectBook(otherBk.index);
    connsEl.appendChild(chip);
  });

  // Link to interlinear
  const bookSlug=bk.name.toLowerCase().replace(/\s+/g,'-');
  document.getElementById('blink').innerHTML=
    `<a href="../interlinear/${bk.abbr.toLowerCase()}/1.html">Read ${bk.name} →</a>`;

  document.getElementById('panel').classList.add('show');
  document.getElementById('hint').style.opacity='0';
}

window.deselect=function deselect(silent){
  if(selectedIdx===-1&&!selected)return;
  selected=null;selectedIdx=-1;
  controls.autoRotate=true;
  conns.forEach(l=>l.material.opacity=l.userData.bo);
  glows.forEach(g=>{g.material.opacity=g.userData.bo;g.scale.setScalar(g.userData.bs)});
  books.forEach(m=>m.material.color.setHex(0xffffff));
  labels.forEach(l=>l.material.opacity=l.userData.isMajor?0.5:0);
  clearFlow();
  if(!silent) document.getElementById('panel').classList.remove('show');
};

// ── Camera animation ──
let camA=null;
function animCam(p,l){camA={sp:camera.position.clone(),ep:p,st:controls.target.clone(),et:l,t0:clock.getElapsedTime(),d:1.8};}
function updCam(t){
  if(!camA)return;let p=Math.min(1,(t-camA.t0)/camA.d);
  if(p>=1){p=1;camA=null;}p=1-Math.pow(1-p,4);
  camera.position.lerpVectors(camA.sp,camA.ep,p);
  controls.target.lerpVectors(camA.st,camA.et,p);
}

// ═══════════════════════════════════════════════
// ANIMATE
// ═══════════════════════════════════════════════
function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime();
  const dt=clock.getDelta();

  updateIntro(t);updCam(t);controls.update();

  // Pulse glows
  if(selectedIdx===-1){
    glows.forEach((g,i)=>{
      const p=Math.sin(t*1.2+i*0.8)*0.12+1;
      g.scale.setScalar(g.userData.bs*p);
    });
  }

  // Rotate rings
  scene.traverse(o=>{
    if(o.userData?.type==='ring')o.rotation.z=t*0.2+o.userData.idx*0.5;
  });

  // Update shaders
  scene.traverse(o=>{
    if(o.isPoints&&o.material.uniforms?.uTime)o.material.uniforms.uTime.value=t;
    if(o.userData?.type==='nebula')o.rotation.y=t*0.003;
  });

  // Shooting stars
  if(shootingStars){
    const p=shootingStars.pos,v=shootingStars.vel;
    let dirty=false;
    v.forEach((vel,i)=>{
      vel.cooldown-=dt;
      if(vel.cooldown>0){p[i*6]=p[i*6+3];p[i*6+1]=p[i*6+4];p[i*6+2]=p[i*6+5];return;}
      vel.life+=dt;
      if(vel.life>vel.maxLife){
        vel.life=0;vel.cooldown=Math.random()*12+4;vel.maxLife=Math.random()*1+0.4;
        const a=Math.random()*Math.PI*2,r=150+Math.random()*200;
        p[i*6]=p[i*6+3]=Math.cos(a)*r;
        p[i*6+1]=p[i*6+4]=Math.random()*100+30;
        p[i*6+2]=p[i*6+5]=Math.sin(a)*r;
        vel.x=(Math.random()-0.5)*10;vel.y=-(Math.random()*4+2);vel.z=(Math.random()-0.5)*10;return;
      }
      p[i*6+3]+=vel.x*dt*60;p[i*6+4]+=vel.y*dt*60;p[i*6+5]+=vel.z*dt*60;
      p[i*6]+=(p[i*6+3]-p[i*6])*dt*4;p[i*6+1]+=(p[i*6+4]-p[i*6+1])*dt*4;p[i*6+2]+=(p[i*6+5]-p[i*6+2])*dt*4;
      dirty=true;
    });
    if(dirty){
      shootingStars.geo.attributes.position.needsUpdate=true;
      shootingStars.mesh.material.opacity=v.some(vel=>vel.cooldown<=0&&vel.life>0)?0.6:0;
    }
  }

  updateFlow(dt);

  // Pulse connections subtly
  if(selectedIdx===-1){
    conns.forEach((l,i)=>{
      if(l.userData.str>0.1){
        const pulse=Math.sin(t*0.8+i*0.3)*0.15+1;
        l.material.opacity=l.userData.bo*pulse;
      }
    });
  }

  composer.passes.forEach(p=>{if(p.uniforms?.uTime)p.uniforms.uTime.value=t;});
  composer.render();
}

function onResize(){
  const w=window.innerWidth,h=window.innerHeight;
  camera.aspect=w/h;camera.updateProjectionMatrix();
  renderer.setSize(w,h,false);
  renderer.domElement.style.width=w+'px';
  renderer.domElement.style.height=h+'px';
  composer.setSize(w,h);
}

init();
</script>
</body>
</html>
