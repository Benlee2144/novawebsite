<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cross-Reference Galaxy — The Unveiled Word</title>
<meta name="description" content="Explore 264,000+ cross-references between every book of the Bible as a stunning 3D galaxy.">
<link rel="icon" href="../favicon.svg" type="image/svg+xml">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#020108;font-family:'Cinzel',Georgia,serif}
canvas{width:100%;height:100%;display:block;cursor:grab}
canvas:active{cursor:grabbing}

#topbar{position:fixed;top:0;left:0;right:0;z-index:100;
  background:linear-gradient(180deg,rgba(2,1,8,0.9) 0%,transparent 100%);
  padding:14px 20px 40px;display:flex;align-items:flex-start;justify-content:space-between;pointer-events:none}
#topbar *{pointer-events:auto}
#topbar a{color:rgba(197,150,12,0.6);text-decoration:none;font-size:0.75rem;transition:color 0.3s}
#topbar a:hover{color:#c5960c}
#title{color:rgba(197,150,12,0.8);font-size:0.9rem;letter-spacing:0.2em;text-transform:uppercase;text-align:center}
#stats{color:rgba(255,245,220,0.3);font-size:0.6rem;letter-spacing:0.08em;font-family:Georgia,serif;text-align:right}

#info{position:fixed;bottom:0;left:0;right:0;z-index:100;text-align:center;
  background:linear-gradient(0deg,rgba(2,1,8,0.95) 0%,rgba(2,1,8,0.6) 60%,transparent 100%);
  padding:40px 24px 24px;transform:translateY(100%);transition:transform 0.6s cubic-bezier(0.4,0,0.2,1)}
#info.show{transform:translateY(0)}
#bookname{color:#c5960c;font-size:1.4rem;margin-bottom:4px;text-shadow:0 0 20px rgba(197,150,12,0.4)}
#bookdetail{color:rgba(255,245,220,0.5);font-size:0.75rem;font-family:Georgia,serif;margin-bottom:6px}
#connections-list{color:rgba(255,245,220,0.35);font-size:0.65rem;font-family:Georgia,serif;line-height:1.7}

#hint{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:99;
  color:rgba(255,245,220,0.2);font-size:0.65rem;font-family:Georgia,serif;letter-spacing:0.1em;
  transition:opacity 2s}

#legend{position:fixed;top:60px;right:16px;z-index:100;opacity:0.5;transition:opacity 0.3s}
#legend:hover{opacity:1}
#legend div{display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer}
#legend .dot{width:6px;height:6px;border-radius:50%}
#legend .lbl{color:rgba(255,245,220,0.5);font-size:0.55rem;font-family:Georgia,serif}

#loading{position:fixed;inset:0;z-index:200;background:#020108;display:flex;flex-direction:column;
  align-items:center;justify-content:center;transition:opacity 1.5s}
#loading.done{opacity:0;pointer-events:none}
#loading h1{color:rgba(197,150,12,0.8);font-size:1.1rem;letter-spacing:0.25em;text-transform:uppercase}
#loading p{color:rgba(255,245,220,0.25);font-size:0.7rem;font-family:Georgia,serif;margin-top:8px}
.bar{width:160px;height:1px;background:rgba(197,150,12,0.1);margin-top:20px;overflow:hidden}
.fill{width:0%;height:100%;background:#c5960c;transition:width 0.4s}

@media(max-width:768px){#legend{display:none}#title{font-size:0.75rem}}
</style>
</head>
<body>
<div id="loading"><h1>✦ Mapping the Galaxy ✦</h1><p>264,000 connections across 66 books</p><div class="bar"><div class="fill" id="lf"></div></div></div>
<div id="topbar"><a href="../">← Home</a><div id="title">Cross-Reference Galaxy</div><div id="stats">66 Books · 264,673 Refs</div></div>
<div id="legend"></div>
<canvas id="c"></canvas>
<div id="info"><div id="bookname"></div><div id="bookdetail"></div><div id="connections-list"></div></div>
<div id="hint">drag to orbit · scroll to zoom · tap a star</div>

<script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>
<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';

const SEC_COL = {
  'Torah':          0xd4a843,
  'History':        0x9e7a2e,
  'Poetry':         0x5b9bd5,
  'Major Prophets': 0xc94040,
  'Minor Prophets': 0xd4784a,
  'Gospels':        0xf5deb3,
  'Church History': 0x3db87a,
  "Paul's Letters": 0x8e44ad,
  'General Letters':0x27ae60,
  'Apocalyptic':    0xe74c3c,
};

let scene,camera,renderer,composer,controls,clock;
let bookMeshes=[],allGlows=[],connLines=[],data=null;
let selected=null,raycaster=new THREE.Raycaster(),mouse=new THREE.Vector2();

function lp(p){document.getElementById('lf').style.width=p+'%'}

// ── Star texture (procedural) ──
function makeStarTex(){
  const c=document.createElement('canvas');c.width=128;c.height=128;
  const x=c.getContext('2d');
  const g=x.createRadialGradient(64,64,0,64,64,64);
  g.addColorStop(0,'rgba(255,255,255,1)');
  g.addColorStop(0.05,'rgba(255,255,255,0.9)');
  g.addColorStop(0.15,'rgba(255,245,220,0.6)');
  g.addColorStop(0.3,'rgba(255,220,150,0.2)');
  g.addColorStop(0.5,'rgba(200,150,80,0.05)');
  g.addColorStop(1,'rgba(0,0,0,0)');
  x.fillStyle=g;x.fillRect(0,0,128,128);
  // Add cross-flare
  x.globalCompositeOperation='lighter';
  const g2=x.createLinearGradient(0,64,128,64);
  g2.addColorStop(0,'rgba(255,255,255,0)');
  g2.addColorStop(0.4,'rgba(255,245,220,0.05)');
  g2.addColorStop(0.5,'rgba(255,255,255,0.15)');
  g2.addColorStop(0.6,'rgba(255,245,220,0.05)');
  g2.addColorStop(1,'rgba(255,255,255,0)');
  x.fillStyle=g2;x.fillRect(0,56,128,16);
  const g3=x.createLinearGradient(64,0,64,128);
  g3.addColorStop(0,'rgba(255,255,255,0)');
  g3.addColorStop(0.4,'rgba(255,245,220,0.05)');
  g3.addColorStop(0.5,'rgba(255,255,255,0.15)');
  g3.addColorStop(0.6,'rgba(255,245,220,0.05)');
  g3.addColorStop(1,'rgba(255,255,255,0)');
  x.fillStyle=g3;x.fillRect(56,0,16,128);
  return new THREE.CanvasTexture(c);
}

function makeGlowTex(col){
  const c=document.createElement('canvas');c.width=64;c.height=64;
  const x=c.getContext('2d');
  const r=((col>>16)&255),g2=((col>>8)&255),b=(col&255);
  const g=x.createRadialGradient(32,32,0,32,32,32);
  g.addColorStop(0,`rgba(${r},${g2},${b},0.3)`);
  g.addColorStop(0.3,`rgba(${r},${g2},${b},0.1)`);
  g.addColorStop(0.7,`rgba(${r},${g2},${b},0.02)`);
  g.addColorStop(1,'rgba(0,0,0,0)');
  x.fillStyle=g;x.fillRect(0,0,64,64);
  return new THREE.CanvasTexture(c);
}

async function init(){
  lp(10);
  scene=new THREE.Scene();
  scene.fog=new THREE.FogExp2(0x020108,0.0025);
  camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,2000);
  camera.position.set(0,60,160);

  renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true,powerPreference:'high-performance'});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=1.0;

  composer=new EffectComposer(renderer);
  composer.addPass(new RenderPass(scene,camera));
  const bloom=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),2.0,0.8,0.3);
  composer.addPass(bloom);

  controls=new OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;controls.dampingFactor=0.04;
  controls.rotateSpeed=0.4;controls.zoomSpeed=0.6;
  controls.minDistance=15;controls.maxDistance=400;
  controls.autoRotate=true;controls.autoRotateSpeed=0.1;

  lp(25);
  const resp=await fetch('../data/galaxy_data.json');
  data=await resp.json();
  lp(40);

  createDeepSpace();
  lp(55);
  createBooks();
  lp(75);
  createConnections();
  lp(90);
  createLegend();
  lp(100);

  addEventListener('resize',onResize);
  renderer.domElement.addEventListener('click',onClick);
  renderer.domElement.addEventListener('mousemove',onHover);
  renderer.domElement.addEventListener('touchend',onTouchEnd,{passive:true});

  clock=new THREE.Clock();
  setTimeout(()=>{document.getElementById('loading').classList.add('done')},600);
  setTimeout(()=>{document.getElementById('hint').style.opacity='0'},6000);
  animate();
}

// ── DEEP SPACE ──
function createDeepSpace(){
  // Distant stars
  const sc=5000,sp=new Float32Array(sc*3),ss=new Float32Array(sc);
  for(let i=0;i<sc;i++){
    const th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1),r=300+Math.random()*500;
    sp[i*3]=r*Math.sin(ph)*Math.cos(th);sp[i*3+1]=r*Math.sin(ph)*Math.sin(th);sp[i*3+2]=r*Math.cos(ph);
    ss[i]=Math.random()*1.2+0.2;
  }
  const sg=new THREE.BufferGeometry();
  sg.setAttribute('position',new THREE.BufferAttribute(sp,3));
  sg.setAttribute('size',new THREE.BufferAttribute(ss,1));
  const sm=new THREE.ShaderMaterial({
    uniforms:{uTime:{value:0},uPR:{value:renderer.getPixelRatio()}},
    vertexShader:`attribute float size;uniform float uTime,uPR;varying float vA;
      void main(){vA=sin(uTime*3.0+position.x*0.05)*0.3+0.7;
      vec4 mv=modelViewMatrix*vec4(position,1.0);gl_Position=projectionMatrix*mv;
      gl_PointSize=size*uPR*(60.0/-mv.z);}`,
    fragmentShader:`varying float vA;void main(){float d=length(gl_PointCoord-0.5);
      if(d>0.5)discard;gl_FragColor=vec4(1.0,0.98,0.93,smoothstep(0.5,0.0,d)*vA*0.6);}`,
    transparent:true,depthWrite:false,blending:THREE.AdditiveBlending
  });
  scene.add(new THREE.Points(sg,sm));

  // Nebula clouds
  const nc=12000,np=new Float32Array(nc*3),ncol=new Float32Array(nc*3),nsz=new Float32Array(nc);
  for(let i=0;i<nc;i++){
    const a=Math.random()*Math.PI*6,r=10+Math.random()*180,h=(Math.random()-0.5)*50;
    const spread=20+r*0.15;
    np[i*3]=Math.cos(a)*r+(Math.random()-0.5)*spread;
    np[i*3+1]=h+Math.sin(a*0.4)*15+(Math.random()-0.5)*20;
    np[i*3+2]=Math.sin(a)*r+(Math.random()-0.5)*spread;
    const t=Math.random();
    if(t<0.4){ncol[i*3]=0.4;ncol[i*3+1]=0.2;ncol[i*3+2]=0.05;}
    else if(t<0.7){ncol[i*3]=0.15;ncol[i*3+1]=0.12;ncol[i*3+2]=0.35;}
    else{ncol[i*3]=0.25;ncol[i*3+1]=0.1;ncol[i*3+2]=0.15;}
    nsz[i]=Math.random()*4+1;
  }
  const ng=new THREE.BufferGeometry();
  ng.setAttribute('position',new THREE.BufferAttribute(np,3));
  ng.setAttribute('color',new THREE.BufferAttribute(ncol,3));
  ng.setAttribute('size',new THREE.BufferAttribute(nsz,1));
  const nm=new THREE.ShaderMaterial({
    uniforms:{uTime:{value:0},uPR:{value:renderer.getPixelRatio()}},
    vertexShader:`attribute float size;varying vec3 vC;uniform float uTime,uPR;
      void main(){vC=color;vec3 p=position;p.y+=sin(uTime*0.08+position.x*0.008)*3.0;
      vec4 mv=modelViewMatrix*vec4(p,1.0);gl_Position=projectionMatrix*mv;
      gl_PointSize=size*uPR*(200.0/-mv.z);}`,
    fragmentShader:`varying vec3 vC;void main(){float d=length(gl_PointCoord-0.5);
      if(d>0.5)discard;gl_FragColor=vec4(vC,smoothstep(0.5,0.1,d)*0.06);}`,
    transparent:true,depthWrite:false,blending:THREE.AdditiveBlending,vertexColors:true
  });
  const nebula=new THREE.Points(ng,nm);
  nebula.userData.isNebula=true;
  scene.add(nebula);
}

// ── BOOKS AS STARS ──
function createBooks(){
  const starTex=makeStarTex();
  const secNames=Object.keys(data.sections);

  data.books.forEach((book,i)=>{
    const si=secNames.indexOf(book.section);
    const bks=data.sections[book.section];
    const bi=bks.indexOf(book.abbr);
    const bn=bks.length;

    const secAngle=(si/secNames.length)*Math.PI*2;
    const innerAngle=(bi/Math.max(bn,1))*(Math.PI*2/secNames.length*0.8);
    const angle=secAngle+innerAngle;
    const baseR=30+si*12+bi*2.5;
    const y=Math.sin(angle*2.5)*12+(Math.random()-0.5)*8;
    const x=Math.cos(angle)*baseR;
    const z=Math.sin(angle)*baseR;

    // Core star size — MUCH smaller
    const sz=Math.max(0.3,Math.pow(book.chapters,0.35)*0.35);
    const col=SEC_COL[book.section]||0xc5960c;

    // Bright core point (small sphere with emissive)
    const coreGeo=new THREE.SphereGeometry(sz,16,16);
    const coreMat=new THREE.MeshBasicMaterial({color:0xffffff});
    const core=new THREE.Mesh(coreGeo,coreMat);
    core.position.set(x,y,z);
    core.userData={book,index:i,sz};
    scene.add(core);
    bookMeshes.push(core);

    // Star glow sprite
    const glowMat=new THREE.SpriteMaterial({
      map:starTex,color:col,transparent:true,blending:THREE.AdditiveBlending,
      depthWrite:false,opacity:0.7
    });
    const glow=new THREE.Sprite(glowMat);
    const glowSize=sz*8+2;
    glow.scale.set(glowSize,glowSize,1);
    glow.position.copy(core.position);
    glow.userData={bookIdx:i,baseScale:glowSize,baseOp:0.7};
    scene.add(glow);
    allGlows.push(glow);

    // Label
    const label=mkLabel(book.name);
    label.position.set(x,y+sz*4+3,z);
    label.material.opacity=0.0; // Hidden by default, show on hover/select
    label.userData={bookIdx:i};
    scene.add(label);
    allGlows.push(label); // reuse array for updates
  });
}

function mkLabel(text){
  const c=document.createElement('canvas');c.width=256;c.height=48;
  const x=c.getContext('2d');
  x.font='500 20px Georgia,serif';x.textAlign='center';x.textBaseline='middle';
  x.shadowColor='rgba(0,0,0,0.9)';x.shadowBlur=4;
  x.fillStyle='rgba(255,245,220,0.9)';x.fillText(text,128,24);
  const t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearFilter;
  const m=new THREE.SpriteMaterial({map:t,transparent:true,depthWrite:false});
  const s=new THREE.Sprite(m);s.scale.set(10,2,1);
  return s;
}

// ── CONNECTIONS ──
function createConnections(){
  const conns=data.connections.slice(0,400);
  const maxC=conns[0]?.count||1;

  conns.forEach(conn=>{
    const fb=data.books.find(b=>b.abbr===conn.from);
    const tb=data.books.find(b=>b.abbr===conn.to);
    if(!fb||!tb)return;
    const fm=bookMeshes[fb.index],tm=bookMeshes[tb.index];
    if(!fm||!tm)return;

    const str=conn.count/maxC;
    const s=fm.position.clone(),e=tm.position.clone();
    const mid=s.clone().add(e).multiplyScalar(0.5);
    mid.y+=5+str*20;

    const curve=new THREE.QuadraticBezierCurve3(s,mid,e);
    const pts=curve.getPoints(24);
    const geo=new THREE.BufferGeometry().setFromPoints(pts);

    // Color from source section
    const fc=SEC_COL[fb.section]||0xc5960c;
    const tc=SEC_COL[tb.section]||0xc5960c;
    const c1=new THREE.Color(fc),c2=new THREE.Color(tc);
    const vc=new Float32Array(pts.length*3);
    for(let i=0;i<pts.length;i++){
      const t=i/(pts.length-1);
      const c=c1.clone().lerp(c2,t);
      vc[i*3]=c.r;vc[i*3+1]=c.g;vc[i*3+2]=c.b;
    }
    geo.setAttribute('color',new THREE.BufferAttribute(vc,3));

    const baseOp=Math.max(0.015,str*0.12);
    const mat=new THREE.LineBasicMaterial({
      vertexColors:true,transparent:true,opacity:baseOp,
      blending:THREE.AdditiveBlending,depthWrite:false
    });
    const line=new THREE.Line(geo,mat);
    line.userData={from:conn.from,to:conn.to,count:conn.count,baseOp};
    scene.add(line);
    connLines.push(line);
  });
}

// ── LEGEND ──
function createLegend(){
  const el=document.getElementById('legend');
  for(const[name,col] of Object.entries(SEC_COL)){
    const d=document.createElement('div');
    const dot=document.createElement('span');dot.className='dot';
    dot.style.background='#'+new THREE.Color(col).getHexString();
    dot.style.boxShadow='0 0 4px #'+new THREE.Color(col).getHexString();
    const lbl=document.createElement('span');lbl.className='lbl';lbl.textContent=name;
    d.append(dot,lbl);el.appendChild(d);
  }
}

// ── INTERACTION ──
function onClick(e){
  mouse.x=(e.clientX/innerWidth)*2-1;
  mouse.y=-(e.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  // Check glow sprites too (bigger hit area)
  const hits=raycaster.intersectObjects(bookMeshes);
  if(hits.length>0) selectBook(hits[0].object.userData.index);
  else deselect();
}

function onTouchEnd(e){
  if(!e.changedTouches.length)return;
  const t=e.changedTouches[0];
  mouse.x=(t.clientX/innerWidth)*2-1;
  mouse.y=-(t.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(bookMeshes);
  if(hits.length>0) selectBook(hits[0].object.userData.index);
}

let hovered=null;
function onHover(e){
  mouse.x=(e.clientX/innerWidth)*2-1;
  mouse.y=-(e.clientY/innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(bookMeshes);
  if(hits.length>0){
    const idx=hits[0].object.userData.index;
    if(hovered!==idx){
      // Show label
      allGlows.forEach(g=>{
        if(g.userData.bookIdx===idx && g.isSprite && g.material.map?.image?.width===256){
          g.material.opacity=0.9;
        }
      });
      if(hovered!==null){
        allGlows.forEach(g=>{
          if(g.userData.bookIdx===hovered && g.isSprite && g.material.map?.image?.width===256 && hovered!==(selected?.userData?.index)){
            g.material.opacity=0;
          }
        });
      }
      hovered=idx;
    }
    renderer.domElement.style.cursor='pointer';
  } else {
    if(hovered!==null && hovered!==(selected?.userData?.index)){
      allGlows.forEach(g=>{
        if(g.userData.bookIdx===hovered && g.isSprite && g.material.map?.image?.width===256){
          g.material.opacity=0;
        }
      });
    }
    hovered=null;
    renderer.domElement.style.cursor='grab';
  }
}

function selectBook(idx){
  const book=data.books[idx];
  const mesh=bookMeshes[idx];
  selected=mesh;
  controls.autoRotate=false;

  // Fly camera
  const tgt=mesh.position.clone();
  const cp=tgt.clone().add(new THREE.Vector3(5,8,25));
  animCam(cp,tgt);

  // Get connections
  const conns=data.connections.filter(c=>c.from===book.abbr||c.to===book.abbr).sort((a,b)=>b.count-a.count);
  const connBooks=new Set(conns.map(c=>c.from===book.abbr?c.to:c.from));
  const totalRefs=conns.reduce((s,c)=>s+c.count,0);

  // Highlight connections
  connLines.forEach(l=>{
    if(l.userData.from===book.abbr||l.userData.to===book.abbr){
      l.material.opacity=Math.min(0.8,l.userData.baseOp*10);
    } else {
      l.material.opacity=0.003;
    }
  });

  // Highlight connected stars, dim others
  allGlows.forEach(g=>{
    if(g.userData.bookIdx===undefined)return;
    const bi=g.userData.bookIdx;
    const bk=data.books[bi];
    if(!bk)return;
    if(bi===idx){
      if(g.userData.baseScale) g.scale.setScalar(g.userData.baseScale*1.8);
      if(g.userData.baseOp) g.material.opacity=1;
      if(g.material.map?.image?.width===256) g.material.opacity=1; // label
    } else if(connBooks.has(bk.abbr)){
      if(g.userData.baseScale) g.material.opacity=g.userData.baseOp||0.7;
      if(g.material.map?.image?.width===256) g.material.opacity=0.6;
    } else {
      if(g.userData.baseOp!==undefined) g.material.opacity=0.08;
      if(g.material.map?.image?.width===256) g.material.opacity=0;
    }
  });

  bookMeshes.forEach((m,i)=>{
    if(i===idx) m.material.color.setHex(0xffffff);
    else if(connBooks.has(data.books[i].abbr)) m.material.color.setHex(0xdddddd);
    else m.material.color.setHex(0x333333);
  });

  // UI
  document.getElementById('bookname').textContent=book.name;
  document.getElementById('bookdetail').textContent=
    `${book.chapters} chapters · ${book.section} · ${totalRefs.toLocaleString()} cross-references`;
  const top8=conns.slice(0,8).map(c=>{
    const o=c.from===book.abbr?c.to:c.from;
    const ob=data.books.find(b=>b.abbr===o);
    return `${ob?ob.name:o} (${c.count.toLocaleString()})`;
  });
  document.getElementById('connections-list').textContent='Top: '+top8.join(' · ');
  document.getElementById('info').classList.add('show');
  document.getElementById('hint').style.opacity='0';
}

function deselect(){
  if(!selected)return;
  selected=null;controls.autoRotate=true;
  connLines.forEach(l=>l.material.opacity=l.userData.baseOp);
  allGlows.forEach(g=>{
    if(g.userData.baseOp!==undefined) g.material.opacity=g.userData.baseOp;
    if(g.userData.baseScale) g.scale.setScalar(g.userData.baseScale);
    if(g.material.map?.image?.width===256) g.material.opacity=0;
  });
  bookMeshes.forEach(m=>m.material.color.setHex(0xffffff));
  document.getElementById('info').classList.remove('show');
}

// ── CAMERA ANIM ──
let camAnim=null;
function animCam(pos,look){
  camAnim={sp:camera.position.clone(),ep:pos,st:controls.target.clone(),et:look,t0:clock.getElapsedTime(),dur:1.8};
}
function updateCam(t){
  if(!camAnim)return;
  let p=(t-camAnim.t0)/camAnim.dur;
  if(p>=1){p=1;camAnim=null;}
  p=1-Math.pow(1-p,3);
  camera.position.lerpVectors(camAnim.sp,camAnim.ep,p);
  controls.target.lerpVectors(camAnim.st,camAnim.et,p);
}

// ── ANIMATE ──
function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime();
  updateCam(t);
  controls.update();

  // Pulse stars gently
  allGlows.forEach((g,i)=>{
    if(g.userData.baseScale && !selected){
      const pulse=Math.sin(t*1.5+i*0.7)*0.08+1;
      g.scale.setScalar(g.userData.baseScale*pulse);
    }
  });

  // Rotate nebula slowly
  scene.traverse(o=>{
    if(o.userData.isNebula){o.material.uniforms.uTime.value=t;o.rotation.y=t*0.005;}
  });

  // Update star field twinkle
  scene.traverse(o=>{
    if(o.isPoints && o.material.uniforms?.uTime) o.material.uniforms.uTime.value=t;
  });

  composer.render();
}

function onResize(){
  camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);composer.setSize(innerWidth,innerHeight);
}

init();
</script>
</body>
</html>
