<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Search &mdash; The Unveiled Word</title>
  <meta name="description" content="Search the entire Living Word library">
  <link rel="stylesheet" href="css/style.css">
  <style>
    #search-input { width: 100%; padding: 14px 18px; font-size: 1.1rem; border: 2px solid rgba(197,150,12,0.3); border-radius: 8px; background: rgba(255,250,240,0.9); font-family: var(--font-reading); margin: 0.5rem 0 1rem; box-sizing: border-box; }
    #search-input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 12px rgba(197,150,12,0.2); }
    .search-cats { display: flex; flex-wrap: wrap; gap: 6px; margin: 0 0 1.5rem; }
    .search-cats label { padding: 5px 12px; background: rgba(197,150,12,0.08); border: 1px solid rgba(197,150,12,0.2); border-radius: 4px; font-size: 0.85rem; cursor: pointer; font-family: var(--font-heading); }
    .search-cats input { margin-right: 4px; }
    #results-count { font-size: 0.9rem; color: var(--ink-light); margin-bottom: 1rem; font-family: var(--font-reading); }
    .sr { padding: 1rem; margin: 0.6rem 0; background: rgba(197,150,12,0.04); border-radius: 6px; border: 1px solid rgba(197,150,12,0.1); }
    .sr a { color: var(--ultramarine); font-family: var(--font-heading); font-size: 1rem; text-decoration: none; }
    .sr a:hover { text-decoration: underline; }
    .sr .cat { font-size: 0.7rem; color: var(--gold); text-transform: uppercase; letter-spacing: 0.05em; font-family: var(--font-heading); }
    .sr p { font-size: 0.9rem; color: var(--ink); margin: 0.3rem 0 0; line-height: 1.5; font-family: var(--font-reading); }
    </style>
</head>
<body>

  <header class="site-header">
    <div class="nav-container">
      <a href="./" class="site-logo">The Unveiled Word</a>
      <button class="nav-toggle" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-links">
        <li><a href="studies/">Studies</a></li>
        <li><a href="interlinear/">Interlinear</a></li>
        <li><a href="lexicon/">Lexicon</a></li>
        <li><a href="reference/">Reference</a></li>
        <li><a href="search.html" class="active">Search</a></li>
      </ul>
    </div>
  </header>

  <div class="book-page">
    <div class="illuminated-border">
      <div class="border-left"></div>
      <div class="border-right"></div>
      <div class="corner-tl"></div>
      <div class="corner-tr"></div>
      <div class="corner-bl"></div>
      <div class="corner-br"></div>

      <main class="page-container">

        <div class="text-center mb-lg">
          <h1>Search</h1>
          <p class="text-faded" style="font-size: 1.05rem; font-style: italic; font-family: var(--font-reading);">
            Search across studies, lexicon, and reference library
          </p>
        </div>
        <hr class="divider-small">

        <input type="text" id="search-input" placeholder="Loading search index..." autocomplete="off" autofocus>
        <div class="search-cats">
          <label><input type="checkbox" checked data-cat="studies"> Studies</label>
          <label><input type="checkbox" checked data-cat="lexicon"> Lexicon</label>
          <label><input type="checkbox" checked data-cat="easton"> Easton&rsquo;s</label>
          <label><input type="checkbox" checked data-cat="isbe"> ISBE</label>
          <label><input type="checkbox" checked data-cat="verse"> Verses</label>
        </div>
        <div id="results-count"></div>
        <div id="results"></div>

        <script>
        let searchIndex = null;
        async function loadIndex() {
          document.getElementById("results").innerHTML = 
            "<p style=\"text-align:center;color:var(--ink-light);padding:2rem;\">Loading search index...</p>";
          try {
            const resp = await fetch("search-index.json?v=2");
            searchIndex = await resp.json();
            document.getElementById("search-input").placeholder = 
              "Search " + searchIndex.length.toLocaleString() + " entries...";
            document.getElementById("results").innerHTML = "";
          } catch(e) {
            document.getElementById("results").innerHTML = 
              "<p>Failed to load search index. Please refresh the page.</p>";
          }
        }
        function search(query) {
          if (!searchIndex || !query || query.length < 2) {
            document.getElementById("results").innerHTML = "";
            document.getElementById("results-count").textContent = "";
            return;
          }
          const cats = {};
          document.querySelectorAll(".search-cats input").forEach(cb => {
            cats[cb.dataset.cat] = cb.checked;
          });
          
          // Normalize HTML entities for proper apostrophe and quote matching
          function normalizeText(text) {
            return text.toLowerCase()
              .replace(/&rsquo;/g, "'")     // Right single quotation mark
              .replace(/&lsquo;/g, "'")     // Left single quotation mark  
              .replace(/&quot;/g, '"')      // Quotation mark
              .replace(/&amp;/g, '&')       // Ampersand
              .replace(/&ldquo;/g, '"')     // Left double quotation mark
              .replace(/&rdquo;/g, '"');    // Right double quotation mark
          }
          
          const normalizedQuery = normalizeText(query);
          const terms = normalizedQuery.split(/\s+/);
          
          const results = searchIndex.filter(entry => {
            if (!cats[entry.c]) return false;
            const searchText = normalizeText(entry.n + " " + entry.t + " " + entry.d);
            return terms.every(t => searchText.includes(t));
          }).slice(0, 100);
          const catNames = {studies:"Study",lexicon:"Lexicon",easton:"Easton's",isbe:"ISBE",verse:"Interlinear"};
          document.getElementById("results-count").textContent = 
            results.length + (results.length >= 100 ? "+" : "") + " results";
          document.getElementById("results").innerHTML = results.map(r => 
            '<div class="sr">' +
            '<span class="cat">' + (catNames[r.c]||r.c) + '</span> ' +
            '<a href="' + r.u + '">' + r.n + '</a>' +
            (r.d ? '<p>' + r.d.substring(0, 200) + '</p>' : '') +
            '</div>'
          ).join("");
        }
        document.getElementById("search-input").addEventListener("input", function() {
          search(this.value);
        });
        document.querySelectorAll(".search-cats input").forEach(cb => {
          cb.addEventListener("change", () => search(document.getElementById("search-input").value));
        });
        loadIndex();
        </script>

      </main>
    </div>
  </div>

  <div class="book-spine" aria-hidden="true"></div>

  <footer class="site-footer">
    <p class="footer-scripture">
      &ldquo;The words of the LORD are pure words, like silver tried in a furnace of earth, purified seven times.&rdquo;
    </p>
    <p class="footer-ref">PSALM 12:6</p>
    <p class="footer-copy">The Unveiled Word &mdash; Soli Deo Gloria</p>
  </footer>
  <!-- Biblical Study Tools -->
  <script src="./js/biblical-geography.js"></script>
  <script src="./js/pronunciation-system.js"></script>
  <script src="./js/manuscript-confidence.js"></script>
  <script src="./js/biblical-study-tools.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof BiblicalStudyTools !== 'undefined') {
        new BiblicalStudyTools({
          dataURL: './',
          enableGeography: true,
          enablePronunciation: true,
          enableManuscripts: true,
          enableCrossRefs: true,
          enableSemanticSearch: true,
          autoEnhance: true
        });
      }
    });
  </script>


  <script src="js/main.js"></script>
<script src="./js/audio-pronunciation.js?v2"></script>
<script src="./js/bg-music.js?v2"></script>
</body>
</html>